---
import Layout from "@/layouts/Layout.astro";
import { didToHandle } from "@/lib/atproto";
import type { Tag } from "@/lib/types";
import { desc } from "astro:db";
import { db, eq, Users, Works } from "astro:db";

const works = await db.select()
  .from(Works)
  .innerJoin(Users, eq(Works.author, Users.userDid))
  .orderBy(Works.title);

const loggedInUser = Astro.locals.loggedInUser;
---

<Layout>
  <main id="content" class="flex flex-col gap-5 max-w-full">
    <header class="flex items-center justify-between">
      <h1>Works</h1>
      {loggedInUser && 
        <a href="/works/add" class="btn btn-primary">wanna write kid?</a>
      }
    </header>

    {works
      .sort((a, b) => (b.Works.updatedAt ?? b.Works.createdAt).valueOf() - (a.Works.updatedAt ?? a.Works.createdAt).valueOf())
      .map(async ({ Works, Users }) => (
      <article class="card rounded-box shadow p-5">
        <header>
          <div class="flex items-center justify-between">
            <hgroup class="flex-1">
              <h2 class="card-title">
                <a href={`/works/${Works.slug}`}>{Works.title}</a>
              </h2>
              <h3>
                {Users.nickname
                  ? Users.nickname
                  : await didToHandle(Users.userDid)}
              </h3>
            </hgroup>
            <time datetime={Works.createdAt.toISOString()}>
              {Works.createdAt.toLocaleDateString()}
            </time>
          </div>
          {Array.isArray(Works.tags)
            ? (<ul class="flex flex-wrap gap-1.5">
                {(Works.tags as Tag[]).map((tag: Tag) => (
                  <li><a class="tag" href={tag.url}>{tag.label}</a></li>
                ))}
              </ul>)
            : <pre>{JSON.stringify(Works.tags)}</pre>}
        </header>

        <div class="card-body prose lg:prose-xl">
          <Fragment set:html={Works.summary} />
        </div>
      </article>
    ))}
  </main>
</Layout>

<style>
  .tag {
    @apply btn btn-accent;  
  }
</style>