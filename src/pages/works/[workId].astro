---
import WorkPage from "@/layouts/WorkPage.astro";
import { didToHandle } from "@/lib/atproto";
import { db, eq, Users, Works } from "astro:db";

const { workId } = Astro.params;

const work = await db.select()
  .from(Works)
  .where(eq(Works.slug, workId!))
  .innerJoin(Users, eq(Works.author, Users.userDid))
  .limit(1);

if (work.length === 0) {
  return Astro.redirect("/not-found");
}
---
{work.map(async ({ Works, Users }) => (
  <WorkPage 
    slug={Works.slug}
    title={Works.title}
    author={await didToHandle(Users.userDid)}
    createdAt={Works.createdAt}
    updatedAt={Works.updatedAt}
    tags={Works.tags}
  >
    <Fragment set:html={Works.content} />
  </WorkPage>
))}